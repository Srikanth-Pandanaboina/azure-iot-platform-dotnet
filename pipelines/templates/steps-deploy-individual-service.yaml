parameters:
  aksName:
  resourceGroupName:
  subscriptionName:
  serviceName:
  blueServiceName: 
  greenServiceName: 
  servicePort:
  serviceProbesEnabled:
  helmVersion:
  imageTag:


steps:
  - script: |-
      echo "aksName: ${{parameters.aksName}}"
      echo "resourceGroupName: ${{parameters.resourceGroupName}}"
      echo "subscriptionName: ${{parameters.subscriptionName}}"
      echo "serviceName: ${{parameters.serviceName}}"
      echo "servicePort: ${{parameters.servicePort}}"
      echo "serviceProbesEnabled: ${{parameters.serviceProbesEnabled}}"
      echo "helmVersion: ${{parameters.helmVersion}}"
      echo "blueServiceName: ${{parameters.blueServiceName}}"
    displayName: Print step variables

  - checkout: self
    displayName: Checkout repository

  - task: HelmInstaller@1
    displayName: Install Helm
    inputs:
      helmVersionToInstall: ${{parameters.helmVersion}}

  - task: HelmDeploy@0
    displayName: Initialize Helm
    inputs:
      connectionType: Azure Resource Manager
      azureSubscription: ${{parameters.subscriptionName}}
      azureResourceGroup: ${{parameters.resourceGroupName}}
      kubernetesCluster: ${{parameters.aksName}}
      namespace: default
      command: init
      arguments: --force-upgrade


  # - task: HelmDeploy@0
  #   displayName: Creation Of Service for first time
  #   inputs:
  #     connectionType: Azure Resource Manager
  #     azureSubscription: 3M-CRSLAD16-BBIoTP-Dev
  #     azureResourceGroup: rg-iot-ggk-dev
  #     kubernetesCluster: ggktech-aks-dev
  #     namespace: default
  #     command: install
  #     chartType: FilePath
  #     chartPath: charts/mmm-iot-service
  #     releaseName: ${{parameters.serviceName}}
  #     overrideValues: nameOverride=${{parameters.serviceName}},service.port=${{parameters.servicePort}},type=blue,deployment.enabled=false,service.enabled=true

  - task: HelmDeploy@0
    displayName: Creation Blue application deployment
    inputs:
      connectionType: Azure Resource Manager
      azureSubscription: 3M-CRSLAD16-BBIoTP-Dev
      azureResourceGroup: rg-iot-ggk-dev
      kubernetesCluster: ggktech-aks-dev
      namespace: default
      command: install
      chartType: FilePath
      chartPath: charts/mmm-iot-service
      releaseName: ${{parameters.blueServiceName}}
      overrideValues: nameOverride=${{parameters.serviceName}},deployment.port.http=${{parameters.servicePort}},deployment.probes.enabled=${{parameters.serviceProbesEnabled}},deployment.image.tag=${{parameters.imageTag}},type=blue,deployment.enabled=true,service.enabled=false,deployment.name=${{parameter.blueServiceName}}

  - task: HelmDeploy@0
    displayName: Creation of Green Deployment
    inputs:
      connectionType: Azure Resource Manager
      azureSubscription: 3M-CRSLAD16-BBIoTP-Dev
      azureResourceGroup: rg-iot-ggk-dev
      kubernetesCluster: ggktech-aks-dev
      namespace: default
      command: install
      chartType: FilePath
      chartPath: charts/mmm-iot-service
      releaseName: ${{parameters.greenServiceName}}
      overrideValues: nameOverride=${{parameters.serviceName}},deployment.port.http=${{parameters.servicePort}},deployment.probes.enabled=${{parameters.serviceProbesEnabled}},type=green,deployment.image.tag=${{parameters.imageTag}},deployment.enabled=true,service.enabled=false,deployment.name=${{parameters.greenServiceName}}
    
      
  - task: HelmDeploy@0
    inputs:
      connectionType: Azure Resource Manager
      azureSubscription: ${{parameters.subscriptionName}}
      azureResourceGroup: ${{parameters.resourceGroupName}}
      kubernetesCluster: ${{parameters.aksName}}
      useClusterAdmin: false
      namespace: default
      command: upgrade
      chartType: FilePath
      chartPath: charts/mmm-iot-service
      releaseName: ${{parameters.serviceName}}
      overrideValues: nameOverride=${{parameters.serviceName}},service.port=${{parameters.servicePort}},type=green,deployment.enabled=false,service.enabled=true
      force: true
      arguments: --cleanup-on-fail --set-string gitSha=$(Build.SourceVersion)
      waitForExecution: true
      install: true
