trigger: none
pr: none
resources:
  pipelines:
    - pipeline: test
      source: azure-iot-platform-dotnet.ci.test
      trigger:
        branches:
          - master
pool:
  vmImage: ubuntu-latest
variables:
  ${{ if eq(variables['Build.Reason'], 'ResourceTrigger') }}:
    _imageTag: $(resources.pipeline.test.runID)
  ${{ if ne(variables['Build.Reason'], 'ResourceTrigger') }}:
    _imageTag: $(imageTag)
stages:
  - stage: checkParameters
    displayName: Check parameters
    dependsOn: []
    jobs:
      - job: checkParameters
        displayName: Check parameters
        steps:
          - checkout: none

          - script: |-
              set -Eeuxo pipefail
              echo "Image tag: '$(_imageTag)'"
              if [ -z "$(_imageTag)" ]
              then
                echo "A value for the 'imageTag' variable must be provided" > /dev/stderr
                exit 1
              fi
            displayName: Check parameters

  - stage: printPipelineResourceVariables
    displayName: Print pipeline resource variables
    dependsOn: []
    jobs:
      - job: printPipelineResourceVariables
        displayName: Print pipeline resource variables
        steps:
          - checkout: none

          - template: ../templates/print-pipeline-resource-variables.yaml
            parameters:
              pipelineResourceName: test

  - stage: kciDev
    displayName: KCI dev
    dependsOn:
      - checkParameters
    jobs:
      - template: ../templates/jobs-deploy-code.yaml
        parameters:
          environmentName: IoT_KCI_Environment_DEV
          subscriptionName: 3M-CRSLBL42-KCI-IoT-RD
          applicationCode: kciiot
          applicationShortCode: kci
          environmentCategory: dev
          imageTag: $(_imageTag)
          blueGreen: true
          subscriptionId: 63eaf61c-4cb7-419e-ac27-553edf67c39d

  - stage: kciQa
    displayName: KCI qa
    dependsOn:
      - kciDev
    jobs:
      - template: ../templates/jobs-deploy-code.yaml
        parameters: 
          environmentName: IoT_KCI_Environment_QA
          subscriptionName: 3M-CRSLBL43-KCI-IoT-QA
          applicationCode: kciiot
          applicationShortCode: kci
          environmentCategory: qa
          imageTag: $(_imageTag)
          blueGreen: true
          subscriptionId: d4fe37c0-d20e-4ef1-91c2-e196016a2410     

  - stage: kciCt
    displayName: KCI ct
    dependsOn:
      - kciQa
    jobs:
      - template: ../templates/jobs-deploy-code.yaml
        parameters:
          environmentName: IoT_KCI_Environment_CT
          subscriptionName: 3M-CRSLBL44-KCI-IoT-CT
          applicationCode: kciiot
          applicationShortCode: kci
          environmentCategory: ct
          imageTag: $(_imageTag)
          blueGreen: true
          subscriptionId:  be48d2d2-4f01-43e1-b700-8fadff21655b

  - stage: kciPr
    displayName: KCI Pr
    dependsOn:
      - kciCt
    jobs:
      - template: ../templates/jobs-deploy-code.yaml
        parameters:
          environmentName: IoT_KCI_Environment_PR
          subscriptionName: 3M-CRSLBL45-KCI-IoT-PR
          applicationCode: kciiot
          applicationShortCode: kci
          environmentCategory: pr
          imageTag: $(_imageTag)
          blueGreen: true
          subscriptionId:  0d62cc0d-a87c-445a-b1f2-091a8f10ee71